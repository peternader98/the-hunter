{% extends 'base.html' %}

{% block links %}
<link rel="stylesheet" href="../static/css/alert-message.css">

<!--table css-->

<link rel="stylesheet" type="text/css" href="../static/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../static/vendor/animate/animate.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../static/vendor/select2/select2.min.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../static/vendor/perfect-scrollbar/perfect-scrollbar.css">
<!--===============================================================================================-->
	<link rel="stylesheet" type="text/css" href="../static/css/util.css">
	<link rel="stylesheet" type="text/css" href="../static/css/main2.css">
	<style>
		body{
			background: white;
		}
	</style>
{% endblock %}

{% block scripts %}
<script src="../static/js/alert-message.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.js"
	integrity="sha256-DrT5NfxfbHvMHux31Lkhxg42LY6of8TaYyK50jnxRnM=" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
	integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous">
	</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>

	function shortStr(str) {
		if (str.length > 12) {
			return str.replace(str.substr(6, str.indexOf(".") - 6), " [..]")
		}
	}

	$(document).on('click', '#upload', function (e) {

		var formdata = new FormData($('#file')[0]);

		if ($("#input").val().trim() != "") {

			$.ajax({
				type: "POST",
				uri: "{{url_for('upload_file')}}",
				encrypt: 'multipart/form-data',
				data: formdata,
				processData: false,
				contentType: false,
				cache: false,
				
				success: function (data) {
					console.log(data)
					if (data.status == true) {
						$("#file").trigger("reset");
						showMessage(data.status, data.msg)

						var dt = new Date();
						var results = data.comparedFiles;
						var keys =  data.keys
						
						var ids = data.ids;
						var percents = data.percents;
						var resultID = document.querySelector('#result');
						var idID = document.querySelector('#ids');
						var table = document.querySelector('#table');
						console.log(results)
						console.log(data.keys)

						keys.forEach((ele, index)=>{
							$('#ids').append(`<th>${ele}</th>`)
							
																						
						})

						keys.forEach((ele, index)=>{
							console.log(results[ele])
							
							let str = `<tr><td>${ele}</td>`
							results[ele].forEach((el, index2)=>{
								
								if(index == index2)
									str += `<td>0</td>`

								str+= `<td>${el.score}</td>`
								
									
									
							})
							if(index == keys.length - 1)
								str+="<td>0</td></tr>"
							else
							  	str += "</tr>"
							$('#mytbody').append(str)															
						})
						/*
						results.forEach((result) => {
							var trow = document.createElement('tr')

							var current_date = document.createElement('td')
							var id_1 = document.createElement('td')
							var name_1 = document.createElement('td')
							var id_2 = document.createElement('td')
							var name_2 = document.createElement('td')
							var percentage = document.createElement('td')
							current_date.setAttribute('class', 'column1')
							id_1.setAttribute('class', 'column1')
							name_1.setAttribute('class', 'column1')
							id_2.setAttribute('class', 'column1')
							name_2.setAttribute('class', 'column1')
							percentage.setAttribute('class', 'column1')
							current_date.innerHTML = (("0"+dt.getDate()).slice(-2)) +"/"+ (("0"+(dt.getMonth()+1)).slice(-2)) +"/"+ (dt.getFullYear()) +" "+ (("0"+dt.getHours()).slice(-2)) +":"+ (("0"+dt.getMinutes()).slice(-2));
							id_1.innerHTML = String(result[0].substr(0,9));
							name_1.innerHTML = String(result[0].substr(10,));
							id_2.innerHTML = String(result[1].substr(0,9));;
							name_2.innerHTML = String(result[1].substr(10,));;
							percentage.innerHTML = String(result[2]).substr(0,5) + '%';

							trow.append(current_date, id_1, name_1, id_2, name_2, percentage)

							resultID.appendChild(trow)
						})
						ids.forEach((id) => {
							var thead = document.createElement('th')
							thead.innerHTML = id
							idID.appendChild(thead)

							var tbody = document.createElement('tbody');
							table.appendChild(tbody);

							var tr = document.createElement('tr');
							tr.setAttribute('class', 'table100-head');
							tbody.appendChild(tr);

							var th = document.createElement('th');
							th.setAttribute('style', 'background: #36304a;');
							th.innerHTML = id;
							tr.appendChild(th);

							for(var i = 0; i < ids.length; i++){
								var td = document.createElement('td');
								if(id == ids[i]){
									td.innerHTML = '100%'
									tr.appendChild(td);
								}
								else if(id == percents[i][0] || id == percents[i][1] && ids[i] == percents[i][0] || ids[i] == percents[i][1]){
									td.innerHTML = String(percents[i][2]).substr(0,5) + '%'
									tr.appendChild(td);
								}
								else{
									td.innerHTML = 'Hunt'
									tr.appendChild(td);
								}
							}
						})
						*/
					}
					
					if (data.status == false) {
						let strError = ""
						let strSuccess = ""

						if (data.notAllowedFiles.length != 0) {
							for (let errorFile of data.notAllowedFiles) {
								strError = strError + shortStr(errorFile) + ", "
							}
							console.log("error files")
							console.log(strError)
						}

						if (data.allowedFiles.length != 0) {
							for (let successFile of data.notAllowedFiles) {
								strSuccess = strSuccess + shortStr(successFile) + ", "
							}
							console.log("success files")
							console.log(strSuccess)
						}

						if (strSuccess != '')
							showMessage(false, "files " + strSuccess + " are uploaded and those files " + strError + " should be doc, docx, pdf or code file")
						else
							showMessage(false, String(strError) + " should be doc, docx, pdf or code file")

						$("#file").trigger("reset");
					}
				},
				error: function (reject) {
					var response = $.parseJSON(reject.responseText);
					console.log(reject)
					showMessage(false, "oh no, there is something whent wrong!!")
				}
			})
		}
		else {
			showMessage(false, "You need to upload at least 1 file.")
		}
	})

</script>

{% endblock %}

{% block body %}

{% include 'includes/alerts/messages.html' %}

{% include 'includes/banner.html' %}

<div class="container" >
	<div class="content">
		<div class="box text-center">
			<form id="file" >
				<input type="file" id="input" name="files[]" multiple="true" autocomplete="off"
					style="margin:auto; width:0px" class="inputfile inputfile-5"
					data-multiple-caption="{count} files selected" multiple style="opacity: 0;" required />
				<label for="input" >
					<figure>
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="17" viewBox="0 0 20 17">
							<path
								d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z" />
						</svg>
					</figure>
					<span></span>
				</label>
			</form>
			<button id="upload" style="border-radius: 20px;padding: 14px 40px;background-color: #f44336; color: white;">Check</button>
		</div>

		<div class="limiter mt-2 mb-2">
			<div>
				<div class="wrap-table100">
					<div class="table100">
						<table id="table">
							<thead>
								<tr class="table100-head" id="ids">
									<th>student ID</th>
								</tr>
							</thead>
							<tbody id="mytbody">
								
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

	</div><!-- Related demos -->
</div><!-- /container -->

<script src="../static/js/custom-file-input.js"></script>
<script>
		(function (e, t, n) { var r = e.querySelectorAll("html")[0]; r.className = r.className.replace(/(^|\s)no-js(\s|$)/, "$1js$2") })
		(document, window, 0);
</script>
<script src="../static/vendors/lightbox/simpleLightbox.min.js"></script>
<script src="../static/vendors/jquery-ui/jquery-ui.js"></script>
<script src="../static/js/theme.js"></script>

<!--table scripts-->

<script src="../static/js/main.js"></script>	
<script src="../static/vendor/select2/select2.min.js"></script>

{% endblock %}